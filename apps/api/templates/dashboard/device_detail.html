<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Device {{ device.serial_number }} details</title>
    {% load static %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Device details for {{ device.serial_number }}</h1>

    {% if messages %}
      <div>
        {% for message in messages %}
          <p>{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}

    <p>
        <strong>Owner:</strong> {{ request.user.username }}<br>
        <strong>Name:</strong> {{ device.name|default:"(unnamed)" }}<br>
        <strong>Created at:</strong> {{ device.created_at }}<br>
        <strong>Last seen:</strong> {{ device.last_seen|default:"never" }}
    </p>

    <p>
        <a href="{% url 'dashboard_devices' %}">&larr; Back to all devices</a>
    </p>

    <hr>

    <h2>API keys</h2>

    <form method="post" style="margin-bottom: 1em;">
      {% csrf_token %}
      <input type="hidden" name="action" value="rotate">
      <button type="submit">Rotate API key (invalidate old keys)</button>
    </form>

    {% if keys %}
      <table border="1" cellpadding="4" cellspacing="0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Created at</th>
            <th>Expires at</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for key in keys %}
            <tr>
              <td>{{ key.id }}</td>
              <td>{{ key.created_at }}</td>
              <td>{{ key.expires_at }}</td>
              <td>
                {% if key.is_active %}
                  active
                {% else %}
                  inactive
                {% endif %}
              </td>
              <td>
                {% if key.is_active %}
                  <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="revoke">
                    <input type="hidden" name="key_id" value="{{ key.id }}">
                    <button type="submit">Revoke</button>
                  </form>
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No keys yet for this device.</p>
    {% endif %}

    <hr>

    <div class="metric-card">
        <h2>Temperature chart (auto updating)</h2>
        <canvas
            id="metric-temperature"
            data-device-serial="{{ device.serial_number }}"
            width="800"
            height="300">
        </canvas>
    </div>

    <hr>

    <h2>Recent telemetry (latest up to 50 samples)</h2>

    <table border="1" cellpadding="4" cellspacing="0">
      <thead>
        <tr>
          <th>Server time</th>
          <th>Device time</th>
          <th>Mode</th>
          <th>Tin (째C)</th>
          <th>Tout (째C)</th>
          <th>Setpoint (째C)</th>
          <th>Hysteresis (째C)</th>
          <th>Humidity (%)</th>
          <th>Output</th>
        </tr>
      </thead>
      <tbody id="telemetry-table-body">
        {% for s in snapshots %}
          <tr>
            <td>{{ s.server_ts }}</td>
            <td>{{ s.device_ts|default:"-" }}</td>
            <td>{{ s.mode }}</td>
            <td>{{ s.temp_inside_c }}</td>
            <td>{{ s.temp_outside_c|default:"-" }}</td>
            <td>{{ s.setpoint_c }}</td>
            <td>{{ s.hysteresis_c|default:"-" }}</td>
            <td>{{ s.humidity_percent|default:"-" }}</td>
            <td>{{ s.output|default:"-" }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <script src="{% static 'api/js/device_detail.js' %}"></script>
</body>
</html>
