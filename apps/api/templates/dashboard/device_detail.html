{% extends "base.html" %}
{% load static %}

{% block title %}Device detail{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    .chart-card {
      min-height: 300px;
    }
    .chart-container {
      position: relative;
      height: 260px;  /* controls chart height */
    }
  </style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-1">Device detail</h2>
  <p class="text-muted mb-3">
    {{ device.name|default:"(unnamed)" }} ·
    Serial:
    <span class="fw-semibold">{{ device.serial_number }}</span>
  </p>

  <div class="d-flex justify-content-between mb-3 small text-muted">
    <span>
      Created:
      {% if device.created_at %}
        {{ device.created_at|date:"Y-m-d H:i" }} UTC
      {% else %}
        unknown
      {% endif %}
    </span>
    <span>
      Last seen:
      {% if device.last_seen %}
        {{ device.last_seen|date:"Y-m-d H:i" }} UTC
      {% else %}
        never
      {% endif %}
    </span>
  </div>

  <!-- Root element used by JS to pick up context -->
  <div
    id="device-detail-root"
    data-device-serial="{{ device.serial_number }}"
    data-telemetry-url="{% url 'telemetry_query' %}">
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" id="deviceDetailTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="main-tab"
        data-bs-toggle="tab"
        data-bs-target="#main-tab-pane"
        type="button"
        role="tab"
        aria-controls="main-tab-pane"
        aria-selected="true">
        Main
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="control-tab"
        data-bs-toggle="tab"
        data-bs-target="#control-tab-pane"
        type="button"
        role="tab"
        aria-controls="control-tab-pane"
        aria-selected="false">
        Control panel
      </button>
    </li>
  </ul>

  <div class="tab-content">

    <!-- Main tab -->
    <div
      class="tab-pane fade show active"
      id="main-tab-pane"
      role="tabpanel"
      aria-labelledby="main-tab">

      <!-- Date range form -->
      <section class="mb-4">
        <form class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="fromDate" class="form-label">From</label>
            <input
              type="datetime-local"
              class="form-control"
              id="fromDate"
              name="from">
          </div>
          <div class="col-md-4">
            <label for="toDate" class="form-label">To</label>
            <input
              type="datetime-local"
              class="form-control"
              id="toDate"
              name="to">
          </div>
          <div class="col-md-4">
            <button
              class="btn btn-primary"
              id="applyRangeBtn"
              type="button">
              Apply range
            </button>
            <p class="form-text mt-2">
              If both fields are empty, the dashboard shows the last 24 hours of data.
            </p>
          </div>
        </form>
      </section>

      <!-- Charts -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Temperature history</h5>
        <div style="height: 260px;">
          <canvas id="tempChart"></canvas>
        </div>
        <small class="text-muted">
          Tin, Tout, and setpoint over time, based on the selected range.
        </small>
      </div>
    </div>
  </div>
</div>


      <!-- Recent telemetry table -->
      <section class="mb-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Recent telemetry</span>
            <span class="badge bg-secondary">
              <span id="samplesCount">{{ snapshots|length }}</span> samples
            </span>
          </div>
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Server time</th>
                  <th>Device time</th>
                  <th>Tin (°C)</th>
                  <th>Tout (°C)</th>
                  <th>SP (°C)</th>
                  <th>Hyst (°C)</th>
                  <th>RH (%)</th>
                  <th>Mode</th>
                  <th>Output</th>
                </tr>
              </thead>
              <tbody>
                {% for s in snapshots %}
                  <tr>
                    <td>
                      {% if s.server_ts %}
                        {{ s.server_ts|date:"Y-m-d H:i:s" }} UTC
                      {% else %}
                        –
                      {% endif %}
                    </td>
                    <td>
                      {% if s.device_ts %}
                        {{ s.device_ts|date:"Y-m-d H:i:s" }} UTC
                      {% else %}
                        –
                      {% endif %}
                    </td>
                    <td>{{ s.temp_inside_c }}</td>
                    <td>{{ s.temp_outside_c }}</td>
                    <td>{{ s.setpoint_c }}</td>
                    <td>{{ s.hysteresis_c }}</td>
                    <td>{{ s.humidity_percent }}</td>
                    <td>{{ s.mode }}</td>
                    <td>{{ s.output }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="9" class="text-muted text-center py-3">
                      No telemetry yet for this device.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <!-- Control panel tab -->
    <div
      class="tab-pane fade"
      id="control-tab-pane"
      role="tabpanel"
      aria-labelledby="control-tab">

      <section class="mb-4">
        <div class="card">
          <div class="card-header">
            API keys
          </div>
          <div class="card-body">
            <p class="small text-muted">
              Rotate keys to generate a new API key for the thermostat.
              Revoke a key to immediately disable it.
            </p>

            <!-- Rotate key form -->
            <form method="post" class="mb-3">
              {% csrf_token %}
              <input type="hidden" name="action" value="rotate">
              <button class="btn btn-warning btn-sm" type="submit">
                Rotate API key
              </button>
            </form>

            <!-- Keys table -->
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Created</th>
                    <th>Expires</th>
                    <th>Active</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for key in keys %}
                    <tr>
                      <td>{{ key.id }}</td>
                      <td>
                        {% if key.created_at %}
                          {{ key.created_at|date:"Y-m-d H:i" }} UTC
                        {% else %}
                          –
                        {% endif %}
                      </td>
                      <td>
                        {% if key.expires_at %}
                          {{ key.expires_at|date:"Y-m-d H:i" }} UTC
                        {% else %}
                          –
                        {% endif %}
                      </td>
                      <td>
                        {% if key.is_active %}
                          <span class="badge bg-success">Active</span>
                        {% else %}
                          <span class="badge bg-secondary">Inactive</span>
                        {% endif %}
                      </td>
                      <td class="text-end">
                        {% if key.is_active %}
                          <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="revoke">
                            <input type="hidden" name="key_id" value="{{ key.id }}">
                            <button
                              type="submit"
                              class="btn btn-outline-danger btn-sm">
                              Revoke
                            </button>
                          </form>
                        {% endif %}
                      </td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="5" class="text-muted text-center py-3">
                        No keys for this device yet.
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </section>

    </div>

  </div>  <!-- /.tab-content -->
</div>    <!-- /.container -->
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <!-- Chart.js and page-specific JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="{% static 'api/js/device_detail.js' %}"></script>
{% endblock %}
