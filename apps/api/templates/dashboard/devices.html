{% extends "base.html" %}

{% block title %}Dashboard - Thermostat Platform{% endblock %}

{% block extra_head %}
<style>
/* ==========================================================================
   Futuristic IoT Animation - Sensors to Cloud
   ========================================================================== */

.iot-hero {
  position: relative;
  background: var(--tp-gradient-dark);
  border-radius: var(--tp-radius-xl);
  padding: 2rem;
  margin-bottom: 2rem;
  overflow: hidden;
  min-height: 280px;
}

/* Light mode: Use a lighter gradient */
:root .iot-hero {
  background: linear-gradient(135deg, #e0f2fe 0%, #c7d2fe 100%);
}

[data-theme="dark"] .iot-hero {
  background: var(--tp-gradient-dark);
}

/* Animated grid background */
.iot-hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    linear-gradient(rgba(14, 165, 233, 0.08) 1px, transparent 1px),
    linear-gradient(90deg, rgba(14, 165, 233, 0.08) 1px, transparent 1px);
  background-size: 50px 50px;
  animation: gridMove 20s linear infinite;
}

[data-theme="dark"] .iot-hero::before {
  background-image: 
    linear-gradient(rgba(14, 165, 233, 0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(14, 165, 233, 0.03) 1px, transparent 1px);
}

@keyframes gridMove {
  0% { transform: translate(0, 0); }
  100% { transform: translate(50px, 50px); }
}

/* Glowing orbs in background */
.iot-hero::after {
  content: '';
  position: absolute;
  top: -50%;
  right: -20%;
  width: 400px;
  height: 400px;
  background: radial-gradient(circle, rgba(14, 165, 233, 0.15) 0%, transparent 70%);
  animation: pulse 4s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.5; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.1); }
}

.iot-content {
  position: relative;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 2rem;
}

.iot-text {
  flex: 1;
}

.iot-text h1 {
  font-size: 2rem;
  font-weight: 700;
  color: #0f172a;
  margin-bottom: 0.5rem;
  text-shadow: 0 2px 20px rgba(14, 165, 233, 0.2);
}

[data-theme="dark"] .iot-text h1 {
  color: #ffffff;
  text-shadow: 0 2px 20px rgba(14, 165, 233, 0.3);
}

.iot-text .subtitle {
  color: rgba(15, 23, 42, 0.7);
  font-size: 1rem;
  margin-bottom: 1rem;
}

[data-theme="dark"] .iot-text .subtitle {
  color: rgba(255, 255, 255, 0.7);
}

.iot-stats {
  display: flex;
  gap: 2rem;
}

.iot-stat {
  text-align: center;
}

.iot-stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--tp-primary);
  text-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
}

[data-theme="dark"] .iot-stat-value {
  color: var(--tp-primary-light);
  text-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
}

.iot-stat-label {
  font-size: 0.75rem;
  color: rgba(15, 23, 42, 0.6);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

[data-theme="dark"] .iot-stat-label {
  color: rgba(255, 255, 255, 0.6);
}

/* ==========================================================================
   IoT Animation Canvas
   ========================================================================== */

.iot-animation {
  position: relative;
  width: 350px;
  height: 220px;
  flex-shrink: 0;
}

/* Central Cloud */
.cloud {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100px;
  height: 60px;
  background: linear-gradient(135deg, rgba(14, 165, 233, 0.3), rgba(99, 102, 241, 0.3));
  border-radius: 50px;
  border: 2px solid rgba(14, 165, 233, 0.5);
  box-shadow: 
    0 0 30px rgba(14, 165, 233, 0.3),
    inset 0 0 20px rgba(14, 165, 233, 0.1);
  animation: cloudPulse 3s ease-in-out infinite;
}

.cloud::before {
  content: '';
  position: absolute;
  top: -25px;
  left: 20px;
  width: 50px;
  height: 50px;
  background: inherit;
  border-radius: 50%;
  border: 2px solid rgba(14, 165, 233, 0.5);
}

.cloud::after {
  content: '';
  position: absolute;
  top: -15px;
  right: 15px;
  width: 35px;
  height: 35px;
  background: inherit;
  border-radius: 50%;
  border: 2px solid rgba(14, 165, 233, 0.5);
}

.cloud-icon {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1.5rem;
  z-index: 5;
}

@keyframes cloudPulse {
  0%, 100% { 
    box-shadow: 0 0 30px rgba(14, 165, 233, 0.3), inset 0 0 20px rgba(14, 165, 233, 0.1);
  }
  50% { 
    box-shadow: 0 0 50px rgba(14, 165, 233, 0.5), inset 0 0 30px rgba(14, 165, 233, 0.2);
  }
}

/* Sensor Nodes */
.sensor {
  position: absolute;
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, var(--tp-card-bg), var(--tp-bg-secondary));
  border: 2px solid var(--tp-primary);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
  animation: sensorFloat 3s ease-in-out infinite;
}

.sensor-1 { top: 10px; left: 10px; animation-delay: 0s; }
.sensor-2 { top: 10px; right: 10px; animation-delay: 0.5s; }
.sensor-3 { bottom: 10px; left: 10px; animation-delay: 1s; }
.sensor-4 { bottom: 10px; right: 10px; animation-delay: 1.5s; }
.sensor-5 { top: 50%; left: 0; transform: translateY(-50%); animation-delay: 0.75s; }
.sensor-6 { top: 50%; right: 0; transform: translateY(-50%); animation-delay: 1.25s; }

@keyframes sensorFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

.sensor-5, .sensor-6 {
  animation: sensorFloatSide 3s ease-in-out infinite;
}

@keyframes sensorFloatSide {
  0%, 100% { transform: translateY(-50%) translateX(0); }
  50% { transform: translateY(-50%) translateX(-3px); }
}

/* Data Packets - Flying dots */
.data-stream {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.data-packet {
  position: absolute;
  width: 8px;
  height: 8px;
  background: var(--tp-primary);
  border-radius: 50%;
  box-shadow: 
    0 0 10px var(--tp-primary),
    0 0 20px var(--tp-primary),
    0 0 30px rgba(14, 165, 233, 0.5);
  opacity: 0;
}

/* Packet animations from each sensor to cloud center */
.packet-1 { animation: flyToCloud1 2s ease-in-out infinite; }
.packet-2 { animation: flyToCloud2 2s ease-in-out infinite 0.3s; }
.packet-3 { animation: flyToCloud3 2s ease-in-out infinite 0.6s; }
.packet-4 { animation: flyToCloud4 2s ease-in-out infinite 0.9s; }
.packet-5 { animation: flyToCloud5 2s ease-in-out infinite 1.2s; }
.packet-6 { animation: flyToCloud6 2s ease-in-out infinite 1.5s; }

@keyframes flyToCloud1 {
  0% { left: 35px; top: 35px; opacity: 1; transform: scale(1); }
  100% { left: 175px; top: 110px; opacity: 0; transform: scale(0.5); }
}

@keyframes flyToCloud2 {
  0% { right: 35px; top: 35px; opacity: 1; transform: scale(1); left: auto; }
  100% { right: 140px; top: 110px; opacity: 0; transform: scale(0.5); left: auto; }
}

@keyframes flyToCloud3 {
  0% { left: 35px; bottom: 35px; opacity: 1; transform: scale(1); top: auto; }
  100% { left: 175px; bottom: 85px; opacity: 0; transform: scale(0.5); top: auto; }
}

@keyframes flyToCloud4 {
  0% { right: 35px; bottom: 35px; opacity: 1; transform: scale(1); top: auto; left: auto; }
  100% { right: 140px; bottom: 85px; opacity: 0; transform: scale(0.5); top: auto; left: auto; }
}

@keyframes flyToCloud5 {
  0% { left: 25px; top: 50%; opacity: 1; transform: translateY(-50%) scale(1); }
  100% { left: 150px; top: 50%; opacity: 0; transform: translateY(-50%) scale(0.5); }
}

@keyframes flyToCloud6 {
  0% { right: 25px; top: 50%; opacity: 1; transform: translateY(-50%) scale(1); left: auto; }
  100% { right: 125px; top: 50%; opacity: 0; transform: translateY(-50%) scale(0.5); left: auto; }
}

/* Connection lines */
.connection-line {
  position: absolute;
  height: 2px;
  background: linear-gradient(90deg, var(--tp-primary), transparent);
  opacity: 0.3;
  transform-origin: left center;
}

.line-1 { top: 35px; left: 60px; width: 100px; transform: rotate(35deg); }
.line-2 { top: 35px; right: 60px; width: 100px; transform: rotate(-35deg); transform-origin: right center; background: linear-gradient(-90deg, var(--tp-primary), transparent); }
.line-3 { bottom: 55px; left: 60px; width: 100px; transform: rotate(-35deg); }
.line-4 { bottom: 55px; right: 60px; width: 100px; transform: rotate(35deg); transform-origin: right center; background: linear-gradient(-90deg, var(--tp-primary), transparent); }
.line-5 { top: 50%; left: 50px; width: 100px; }
.line-6 { top: 50%; right: 50px; width: 100px; transform-origin: right center; background: linear-gradient(-90deg, var(--tp-primary), transparent); }

/* Live indicator */
.live-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
  padding: 0.375rem 0.75rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.live-dot {
  width: 8px;
  height: 8px;
  background: #10b981;
  border-radius: 50%;
  animation: livePulse 1.5s ease-in-out infinite;
}

@keyframes livePulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
  50% { opacity: 0.7; box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
}

/* Device Status Indicator in Table */
.device-status-cell {
  min-width: 120px;
}

.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-dot.online {
  background: #10b981;
  box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
  animation: statusPulse 2s ease-in-out infinite;
}

.status-dot.offline {
  background: #6b7280;
  box-shadow: none;
}

@keyframes statusPulse {
  0%, 100% { 
    box-shadow: 0 0 4px rgba(16, 185, 129, 0.4);
    transform: scale(1);
  }
  50% { 
    box-shadow: 0 0 12px rgba(16, 185, 129, 0.8);
    transform: scale(1.1);
  }
}

.status-text {
  font-weight: 600;
  font-size: 0.875rem;
}

.status-timestamp {
  font-size: 0.75rem;
  margin-top: 0.125rem;
}

/* Responsive */
@media (max-width: 768px) {
  .iot-content {
    flex-direction: column;
    text-align: center;
  }
  
  .iot-animation {
    width: 280px;
    height: 180px;
  }
  
  .iot-stats {
    justify-content: center;
  }
  
  .sensor {
    width: 40px;
    height: 40px;
    font-size: 1rem;
  }
  
  .cloud {
    width: 80px;
    height: 50px;
  }
}
</style>
{% endblock %}

{% block content %}
  <!-- Futuristic IoT Hero Animation -->
  <div class="iot-hero">
    <div class="iot-content">
      <div class="iot-text">
        <div class="live-badge mb-3">
          <span class="live-dot"></span>
          Live Monitoring
        </div>
        <h1>Welcome, {{ request.user.username }}</h1>
        <p class="subtitle">Your IoT command center for smart thermostat management</p>
        
        <div class="iot-stats">
          <div class="iot-stat">
            <div class="iot-stat-value">{{ devices|length }}</div>
            <div class="iot-stat-label">Devices</div>
          </div>
          <div class="iot-stat">
            <div class="iot-stat-value" id="activeCount">{{ devices|length }}</div>
            <div class="iot-stat-label">Online</div>
          </div>
          <div class="iot-stat">
            <div class="iot-stat-value">24/7</div>
            <div class="iot-stat-label">Uptime</div>
          </div>
        </div>
      </div>
      
      <!-- Animated IoT Visualization -->
      <div class="iot-animation">
        <!-- Connection Lines -->
        <div class="connection-line line-1"></div>
        <div class="connection-line line-2"></div>
        <div class="connection-line line-3"></div>
        <div class="connection-line line-4"></div>
        <div class="connection-line line-5"></div>
        <div class="connection-line line-6"></div>
        
        <!-- Sensor Nodes -->
        <div class="sensor sensor-1">üå°Ô∏è</div>
        <div class="sensor sensor-2">üì°</div>
        <div class="sensor sensor-3">üí®</div>
        <div class="sensor sensor-4">üî•</div>
        <div class="sensor sensor-5">‚ùÑÔ∏è</div>
        <div class="sensor sensor-6">üìä</div>
        
        <!-- Central Cloud -->
        <div class="cloud">
          <span class="cloud-icon">‚òÅÔ∏è</span>
        </div>
        
        <!-- Flying Data Packets -->
        <div class="data-stream">
          <div class="data-packet packet-1"></div>
          <div class="data-packet packet-2"></div>
          <div class="data-packet packet-3"></div>
          <div class="data-packet packet-4"></div>
          <div class="data-packet packet-5"></div>
          <div class="data-packet packet-6"></div>
        </div>
      </div>
    </div>
  </div>

  <section>
    <h2 class="h5 mb-3">Your devices</h2>

    {% if devices %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col">Status</th>
              <th scope="col">Serial number</th>
              <th scope="col">Name</th>
              <th scope="col">Current Temp</th>
              <th scope="col">Last Updated</th>
              <th scope="col">Active keys</th>
            </tr>
          </thead>
          <tbody>
            {% for device in devices %}
              <tr>
                <td>
                  <div class="device-status-cell" data-serial="{{ device.serial_number }}" data-last-seen="{{ device.last_seen|date:'c' }}">
                    <span class="status-indicator">
                      <span class="status-dot"></span>
                      <span class="status-text">--</span>
                    </span>
                    <small class="status-timestamp text-muted d-block"></small>
                  </div>
                </td>
                <td>
                  <a href="{% url 'dashboard_device_detail' device.id %}">
                    {{ device.serial_number }}
                  </a>
                </td>
                <td>{{ device.name|default:"(unnamed)" }}</td>
                <td class="device-temp-cell" data-serial="{{ device.serial_number }}">
                  <span class="temp-value">--</span>
                </td>
                <td class="device-lastupdated-cell" data-serial="{{ device.serial_number }}">
                  <span class="lastupdated-value">--</span>
                </td>
                <td>{{ device.active_key_count }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>You do not have any devices yet. Use the Register New Device tab to add one.</p>
    {% endif %}
  </section>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  const ONLINE_THRESHOLD_MS = 20 * 1000; // 20 seconds - consider online if heard within (ESP32 sends every 15s)
  const API_URL = '/api/devices/';

  function formatTimeAgo(date) {
    if (!date) return 'Never';
    const now = new Date();
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);

    if (diffSec < 60) return 'Just now';
    if (diffMin < 60) return `${diffMin}m ago`;
    if (diffHour < 24) return `${diffHour}h ago`;
    if (diffDay < 7) return `${diffDay}d ago`;
    return date.toLocaleDateString();
  }

  function updateCellStatus(cell, lastSeenStr) {
    const dot = cell.querySelector('.status-dot');
    const text = cell.querySelector('.status-text');
    const timestamp = cell.querySelector('.status-timestamp');

    if (!lastSeenStr) {
      dot.className = 'status-dot offline';
      text.textContent = 'Offline';
      text.className = 'status-text text-danger';
      timestamp.textContent = 'Never connected';
      return false;
    } else {
      const lastSeen = new Date(lastSeenStr);
      const now = new Date();
      const diffMs = now - lastSeen;
      const isOnline = diffMs < ONLINE_THRESHOLD_MS;

      if (isOnline) {
        dot.className = 'status-dot online';
        text.textContent = 'Online';
        text.className = 'status-text text-success';
      } else {
        dot.className = 'status-dot offline';
        text.textContent = 'Offline';
        text.className = 'status-text text-danger';
      }
      timestamp.textContent = formatTimeAgo(lastSeen);
      return isOnline;
    }
  }

  async function fetchAndUpdateStatuses() {
    try {
      const response = await fetch(API_URL, {
        credentials: 'same-origin',
        headers: {
          'Accept': 'application/json',
        }
      });
      
      if (!response.ok) {
        console.warn('Failed to fetch device statuses:', response.status);
        return;
      }
      
      const data = await response.json();
      const devices = data.results || [];
      
      // Build a map of serial_number -> device data
      const deviceMap = {};
      devices.forEach(d => {
        deviceMap[d.serial_number] = {
          last_seen: d.last_seen,
          current_temp: d.current_temp
        };
      });
      
      // Update each cell based on fresh data
      const statusCells = document.querySelectorAll('.device-status-cell');
      const tempCells = document.querySelectorAll('.device-temp-cell');
      const lastUpdatedCells = document.querySelectorAll('.device-lastupdated-cell');
      let onlineCount = 0;
      
      statusCells.forEach(cell => {
        const serialNumber = cell.dataset.serial;
        const deviceData = deviceMap[serialNumber] || {};
        const lastSeenStr = deviceData.last_seen;
        
        // Update the data attribute with fresh value
        cell.dataset.lastSeen = lastSeenStr || '';
        
        if (updateCellStatus(cell, lastSeenStr)) {
          onlineCount++;
        }
      });
      
      // Update temperature cells
      tempCells.forEach(cell => {
        const serialNumber = cell.dataset.serial;
        const deviceData = deviceMap[serialNumber] || {};
        const tempEl = cell.querySelector('.temp-value');
        if (tempEl) {
          if (deviceData.current_temp !== null && deviceData.current_temp !== undefined) {
            tempEl.textContent = deviceData.current_temp.toFixed(1) + '¬∞C';
            tempEl.style.color = '#10b981';
          } else {
            tempEl.textContent = '--';
            tempEl.style.color = '';
          }
        }
      });
      
      // Update last updated cells
      lastUpdatedCells.forEach(cell => {
        const serialNumber = cell.dataset.serial;
        const deviceData = deviceMap[serialNumber] || {};
        const lastUpdatedEl = cell.querySelector('.lastupdated-value');
        if (lastUpdatedEl) {
          if (deviceData.last_seen) {
            lastUpdatedEl.textContent = formatTimeAgo(new Date(deviceData.last_seen));
          } else {
            lastUpdatedEl.textContent = 'Never';
          }
        }
      });
      
      // Update the online count in the hero section
      const activeCountEl = document.getElementById('activeCount');
      if (activeCountEl) {
        activeCountEl.textContent = onlineCount;
      }
    } catch (err) {
      console.warn('Error fetching device statuses:', err);
    }
  }

  // Initial fetch
  fetchAndUpdateStatuses();

  // Refresh every 5 seconds
  setInterval(fetchAndUpdateStatuses, 5000);
})();
</script>
{% endblock %}
